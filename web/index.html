<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîÆ Mystic Mentor</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîÆ</text></svg>" type="image/svg+xml">
    <link rel="stylesheet" href="themes.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Auth0 SPA SDK with fallback -->
    <script>
      // Load Auth0 SDK with fallback
      (function() {
        const primaryCDN = 'https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js';
        const fallbackCDN = 'https://unpkg.com/@auth0/auth0-spa-js@2.1.3/dist/auth0-spa-js.production.js';
        
        function loadScript(src, onSuccess, onError) {
          const script = document.createElement('script');
          script.src = src;
          script.onload = onSuccess;
          script.onerror = onError;
          document.head.appendChild(script);
        }
        
        console.log('üì¶ Loading Auth0 SDK from primary CDN...');
        loadScript(primaryCDN, 
          () => console.log('‚úÖ Auth0 SDK loaded from primary CDN'),
          () => {
            console.warn('‚ö†Ô∏è Primary CDN failed, trying fallback...');
            loadScript(fallbackCDN,
              () => console.log('‚úÖ Auth0 SDK loaded from fallback CDN'),
              () => console.error('‚ùå Both CDNs failed to load Auth0 SDK')
            );
          }
        );
      })();
    </script>
    
    <style>
        /* Global reset for proper height handling */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }
        
        #root {
            height: 100vh;
            width: 100%;
        }
        
        /* Custom scrollbar for chat */
        .chat-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .chat-scroll::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .chat-scroll::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 3px;
        }
        .chat-scroll::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" src="hooks/useTheme.js"></script>
    <script type="text/babel" src="components/ThemeSwitcher.js"></script>
    <script type="text/babel" src="services/apiService.js"></script>
    <script type="text/babel" src="services/auth0Service.js"></script>
    <script type="text/babel" src="services/stripeService.js"></script>
    <script type="text/babel" src="hooks/useAuth.js"></script>
    <script type="text/babel" src="components/AuthButton.js"></script>
    <script type="text/babel" src="components/AuthStatusBanner.js"></script>

    <script type="text/babel" src="components/PremiumModal.js"></script>
    <script type="text/babel" src="components/SidebarAuthButton.js"></script>
    <script type="text/babel" src="components/TopBarUserProfile.js"></script>
    <script type="text/babel" src="data/lunar_phases.js"></script>
    <script type="text/babel" src="components/MessageActions.js"></script>
    <script type="text/babel" src="components/ConversationStarters.js"></script>
    <script type="text/babel" src="components/Sidebar.js"></script>
    <script type="text/babel" src="components/ChatArea.js"></script>
    <script type="text/babel" src="components/TopBar.js"></script>
    <script type="text/babel" src="components/Modals.js"></script>
    <script type="text/babel" src="components/ArchivedSessions.js"></script>
    <script type="text/babel" src="hooks/useAppLogic.js"></script>
    <script type="text/babel" src="app.js"></script>
    <script>
      // Initialize Auth0 with improved error handling and timing
      (async function() {
        let initAttempts = 0;
        const maxAttempts = 10; // Increased attempts
        const retryDelay = 500; // Reduced delay for faster retries

        async function waitForAuth0SDK() {
          return new Promise((resolve, reject) => {
            const checkAuth0 = () => {
              if (typeof auth0 !== 'undefined' && auth0.createAuth0Client) {
                resolve(true);
              } else if (initAttempts >= maxAttempts) {
                reject(new Error(`Auth0 SDK failed to load after ${maxAttempts} attempts. This may be due to network issues or CDN problems.`));
              } else {
                initAttempts++;
                console.log(`‚è≥ Waiting for Auth0 SDK... (attempt ${initAttempts}/${maxAttempts})`);
                setTimeout(checkAuth0, retryDelay);
              }
            };
            checkAuth0();
          });
        }

        try {
          console.log('üöÄ Starting Auth0 initialization...');
          
          // Wait for Auth0 SDK to load
          await waitForAuth0SDK();
          console.log('‚úÖ Auth0 SDK loaded successfully');
          
          // Wait for Auth0 service to be available
          let serviceAttempts = 0;
          const maxServiceAttempts = 20;
          while (!window.initAuth0 && serviceAttempts < maxServiceAttempts) {
            serviceAttempts++;
            console.log(`‚è≥ Waiting for Auth0 service... (attempt ${serviceAttempts}/${maxServiceAttempts})`);
            await new Promise(resolve => setTimeout(resolve, 100));
          }
          
          // Initialize Auth0
          if (window.initAuth0) {
            await window.initAuth0();
            console.log('‚úÖ Auth0 initialization complete');
            
            // Initialize other services now that Auth0 is ready
            if (window.serviceManager) {
              await window.serviceManager.initializeServices();
            }
            
            // Remove any existing error banners
            const existingError = document.querySelector('.auth-error-banner');
            if (existingError) {
              existingError.remove();
            }
          } else {
            throw new Error('Auth0 service not available after waiting');
          }
        } catch (error) {
          console.error('‚ùå Auth0 initialization failed:', error);
          
          // Show user-friendly error with more details
          const errorDiv = document.createElement('div');
          errorDiv.className = 'auth-error-banner';
          errorDiv.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #dc2626;
            color: white;
            padding: 12px;
            text-align: center;
            z-index: 9999;
            font-family: system-ui, -apple-system, sans-serif;
          `;
          
          let errorMessage = '‚ö†Ô∏è Authentication service failed to load.';
          if (error.message.includes('Auth0 SDK failed to load')) {
            errorMessage += ' Network or CDN issue detected.';
          } else if (error.message.includes('service not available after waiting')) {
            errorMessage += ' Service scripts failed to load properly.';
          } else if (error.message.includes('service not available')) {
            errorMessage += ' Service initialization failed.';
          }
          
          errorDiv.innerHTML = `
            ${errorMessage} Please refresh the page.
            <button onclick="window.location.reload()" style="margin-left: 10px; padding: 4px 8px; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 4px; cursor: pointer;">
              Refresh
            </button>
            <button onclick="this.parentElement.style.display='none'" style="margin-left: 5px; padding: 4px 8px; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 4px; cursor: pointer;">
              Dismiss
            </button>
          `;
          document.body.appendChild(errorDiv);
          
          // Auto-dismiss after 15 seconds (increased time)
          setTimeout(() => {
            if (errorDiv.parentElement) {
              errorDiv.style.opacity = '0';
              errorDiv.style.transition = 'opacity 0.5s';
              setTimeout(() => {
                if (errorDiv.parentElement) {
                  errorDiv.remove();
                }
              }, 500);
            }
          }, 15000);
        }
      })();
    </script>
    <script>
      // Service Initialization Coordinator
      window.serviceManager = {
        auth0Ready: false,
        servicesInitialized: false,
        
        async initializeServices() {
          console.log('üöÄ Starting service initialization sequence...');
          
          try {
            // Wait for Auth0 to be ready
            await this.waitForAuth0();
            this.auth0Ready = true;
            console.log('‚úÖ Auth0 ready, initializing other services...');
            
            // Initialize Stripe service now that Auth0 is ready
            if (window.stripeService) {
              await window.stripeService.init();
              console.log('‚úÖ StripeService initialized');
            }
            
            this.servicesInitialized = true;
            console.log('‚úÖ All services initialized successfully');
            
            // Dispatch event for components that need to know
            window.dispatchEvent(new CustomEvent('servicesReady'));
            
          } catch (error) {
            console.error('‚ùå Service initialization failed:', error);
          }
        },
        
        async waitForAuth0() {
          let attempts = 0;
          const maxAttempts = 100; // 10 seconds max wait
          
          while (attempts < maxAttempts) {
            if (window.auth0Ready && window.getAuth0State) {
              return true;
            }
            
            if (window.auth0InitError) {
              console.warn('‚ö†Ô∏è Auth0 failed, continuing without auth');
              return false;
            }
            
            attempts++;
            await new Promise(resolve => setTimeout(resolve, 100));
          }
          
          throw new Error('Timeout waiting for Auth0 initialization');
        }
      };
    </script>
</body>
</html> 